# =============================================================================
# Docker Compose for Production Deployment (Linux Server)
# =============================================================================
# 
# Deployment URL: https://webapps.henn.com/forma-tree
# 
# This file is configured for deployment on the company's Linux server.
# It uses the "Carbonitor" pattern where an Nginx container acts as the gateway.
#
# Port Assignment:
# - Nginx Gateway: 8012 (Exposed to host)
# - Backend (Express + React): 3001 (Internal)
# - Python API (FastAPI): 5001 (Internal)
#
# Usage:
#   docker-compose -f docker-compose.production.yml pull
#   docker-compose -f docker-compose.production.yml up -d
#
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # Express Backend + React Frontend (Main Application)
  # ===========================================================================
  forma-trees-backend:
    image: ghcr.io/henn-dt/forma-trees-backend:latest
    container_name: forma-trees-backend
    restart: always
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - PORT=3001
      - PYTHON_API_URL=http://forma-trees-python:5001
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - SESSION_SECRET=${SESSION_SECRET}
      - JWT_SECRET=${JWT_SECRET}
      - DIRECTUS_URL=${DIRECTUS_URL}
      - DIRECTUS_STATIC_TOKEN=${DIRECTUS_STATIC_TOKEN}
      - APP_URL=${APP_URL}
    networks:
      - forma-network

  # ===========================================================================
  # Python API (Tree Detection & 3D Models)
  # ===========================================================================
  forma-trees-python:
    image: ghcr.io/henn-dt/forma-trees-python:latest
    container_name: forma-trees-python
    restart: always
    env_file:
      - .env
    environment:
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
    ports:
      - "5012:5001"  
    networks:
      - forma-network

  # ===========================================================================
  # Nginx Gateway (Matches Carbonitor Pattern)
  # ===========================================================================
  nginx:
    image: nginx:alpine
    container_name: forma-trees-nginx
    restart: always
    ports:
      - "8012:80"   
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - forma-trees-backend
    networks:
      - forma-network

networks:
  forma-network:
    driver: bridge
